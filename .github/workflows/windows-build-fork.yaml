name: Windows Build - Fixed CUDA Version Issues

on:
  workflow_dispatch:
    inputs:
      python_version:
        description: 'Python version'
        required: true
        default: '3.10'
        type: choice
        options:
          - '3.10'
          - '3.11'
          - '3.12'
      torch_version:
        description: 'PyTorch version'
        required: true
        default: '2.7'
        type: choice
        options:
          - '2.5'
          - '2.6'
          - '2.7'
      cuda_version:
        description: 'CUDA version'
        required: true
        default: '12.8'
        type: choice
        options:
          - '12.1'
          - '12.4'
          - '12.6'
          - '12.8'

permissions:
  contents: write

jobs:
  # éªŒè¯ç‰ˆæœ¬å…¼å®¹æ€§
  validate-compatibility:
    runs-on: ubuntu-latest
    outputs:
      is_compatible: ${{ steps.check.outputs.is_compatible }}
      cuda_version: ${{ steps.check.outputs.cuda_version }}
      torch_short_cuda: ${{ steps.check.outputs.torch_short_cuda }}
    steps:
      - name: Check PyTorch and CUDA compatibility
        id: check
        run: |
          PYTHON_VERSION="${{ github.event.inputs.python_version || '3.10' }}"
          TORCH_VERSION="${{ github.event.inputs.torch_version || '2.7' }}"
          CUDA_VERSION="${{ github.event.inputs.cuda_version || '12.8' }}"
          
          echo "Checking compatibility for PyTorch $TORCH_VERSION with CUDA $CUDA_VERSION"
          
          # å®šä¹‰å…¼å®¹æ€§çŸ©é˜µ
          COMPATIBLE=false
          case "$TORCH_VERSION" in
            "2.5")
              case "$CUDA_VERSION" in
                "12.1"|"12.4") COMPATIBLE=true ;;
              esac
              ;;
            "2.6")
              case "$CUDA_VERSION" in
                "12.4"|"12.6") COMPATIBLE=true ;;
              esac
              ;;
            "2.7")
              case "$CUDA_VERSION" in
                "12.8") COMPATIBLE=true ;;
              esac
              ;;
          esac
          
          if [ "$COMPATIBLE" = false ]; then
            echo "âŒ ä¸å…¼å®¹çš„ç‰ˆæœ¬ç»„åˆ: PyTorch $TORCH_VERSION + CUDA $CUDA_VERSION"
            echo "âœ… æ¨èç»„åˆ:"
            echo "  - PyTorch 2.5: CUDA 12.1, 12.4"
            echo "  - PyTorch 2.6: CUDA 12.4, 12.6"
            echo "  - PyTorch 2.7: CUDA 12.8"
            exit 1
          fi
          
          echo "âœ… ç‰ˆæœ¬å…¼å®¹: PyTorch $TORCH_VERSION + CUDA $CUDA_VERSION"
          
          # è¾“å‡ºç»“æœ
          echo "is_compatible=true" >> $GITHUB_OUTPUT
          echo "cuda_version=$CUDA_VERSION" >> $GITHUB_OUTPUT
          
          # è®¡ç®—PyTorchç´¢å¼•URLä½¿ç”¨çš„CUDAç‰ˆæœ¬
          CUDA_SHORT_VERSION=${CUDA_VERSION//.}
          echo "torch_short_cuda=cu$CUDA_SHORT_VERSION" >> $GITHUB_OUTPUT

  # ä¸»æ„å»ºä»»åŠ¡
  build-windows-wheel:
    runs-on: windows-2022  # ä½¿ç”¨æ›´æ–°çš„è¿è¡Œç¯å¢ƒ
    needs: validate-compatibility
    if: needs.validate-compatibility.outputs.is_compatible == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ github.event.inputs.python_version || '3.10' }}

      - name: Download and Install CUDA
        shell: powershell
        run: |
          $cudaVersion = "${{ needs.validate-compatibility.outputs.cuda_version }}"
          
          # å®šä¹‰æ¯ä¸ªCUDAç‰ˆæœ¬çš„æ­£ç¡®ä¸‹è½½URL
          $cudaUrls = @{
              "12.1" = "https://developer.download.nvidia.com/compute/cuda/12.1.0/local_installers/cuda_12.1.0_531.14_windows.exe"
              "12.4" = "https://developer.download.nvidia.com/compute/cuda/12.4.1/local_installers/cuda_12.4.1_551.78_windows.exe"
              "12.6" = "https://developer.download.nvidia.com/compute/cuda/12.6.0/local_installers/cuda_12.6.0_560.76_windows.exe"
              "12.8" = "https://developer.download.nvidia.com/compute/cuda/12.8.0/local_installers/cuda_12.8.0_571.96_windows.exe"
          }
          
          # è·å–ä¸‹è½½URL
          $downloadUrl = $cudaUrls[$cudaVersion]
          if (-not $downloadUrl) {
              Write-Error "æœªæ‰¾åˆ°CUDAç‰ˆæœ¬ $cudaVersion çš„ä¸‹è½½é“¾æ¥"
              exit 1
          }
          
          Write-Host "æ­£åœ¨ä¸‹è½½CUDA $cudaVersion..."
          Write-Host "ä¸‹è½½é“¾æ¥: $downloadUrl"
          
          $installerPath = "cuda_installer.exe"
          
          # ä¸‹è½½CUDAå®‰è£…ç¨‹åºï¼Œå¸¦é‡è¯•æœºåˆ¶
          $maxRetries = 3
          $retryCount = 0
          
          do {
              try {
                  Invoke-WebRequest -Uri $downloadUrl -OutFile $installerPath -TimeoutSec 1800
                  $downloadSuccess = $true
                  break
              } catch {
                  $retryCount++
                  Write-Host "ä¸‹è½½å¤±è´¥ (å°è¯• $retryCount/$maxRetries): $($_.Exception.Message)"
                  if ($retryCount -ge $maxRetries) {
                      throw "ä¸‹è½½CUDAå®‰è£…ç¨‹åºå¤±è´¥: $($_.Exception.Message)"
                  }
                  Start-Sleep -Seconds 30
              }
          } while ($retryCount -lt $maxRetries)
          
          # éªŒè¯ä¸‹è½½çš„æ–‡ä»¶
          if (-not (Test-Path $installerPath)) {
              Write-Error "CUDAå®‰è£…ç¨‹åºä¸‹è½½å¤±è´¥"
              exit 1
          }
          
          $fileSize = (Get-Item $installerPath).Length / 1MB
          Write-Host "ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶å¤§å°: $([math]::Round($fileSize, 2)) MB"
          
          # é™é»˜å®‰è£…CUDA (åªå®‰è£…ç¼–è¯‘éœ€è¦çš„ç»„ä»¶)
          Write-Host "æ­£åœ¨å®‰è£…CUDA $cudaVersion..."
          $installArgs = @(
              "-s"  # é™é»˜å®‰è£…
              "nvcc_$cudaVersion"
              "cudart_$cudaVersion" 
              "curand_$cudaVersion"
              "cublas_$cudaVersion"
              "cusparse_$cudaVersion"
              "cusolver_$cudaVersion"
              "cufft_$cudaVersion"
              "curand_dev_$cudaVersion"
              "cublas_dev_$cudaVersion"
              "cusparse_dev_$cudaVersion"
              "cusolver_dev_$cudaVersion"
              "cufft_dev_$cudaVersion"
          )
          
          $process = Start-Process -FilePath $installerPath -ArgumentList $installArgs -Wait -PassThru -NoNewWindow
          
          if ($process.ExitCode -ne 0) {
              Write-Error "CUDAå®‰è£…å¤±è´¥ï¼Œé€€å‡ºä»£ç : $($process.ExitCode)"
              exit 1
          }
          
          Write-Host "CUDAå®‰è£…å®Œæˆ"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          $cudaPath = "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v$cudaVersion"
          
          if (-not (Test-Path $cudaPath)) {
              Write-Error "CUDAå®‰è£…è·¯å¾„ä¸å­˜åœ¨: $cudaPath"
              exit 1
          }
          
          echo "CUDA_PATH=$cudaPath" >> $env:GITHUB_ENV
          echo "CUDA_HOME=$cudaPath" >> $env:GITHUB_ENV
          echo "$cudaPath\bin" >> $env:GITHUB_PATH
          echo "$cudaPath\libnvvp" >> $env:GITHUB_PATH

      - name: Verify CUDA installation
        shell: cmd
        run: |
          echo "éªŒè¯CUDAå®‰è£…..."
          echo "CUDA_PATH=%CUDA_PATH%"
          echo "CUDA_HOME=%CUDA_HOME%"
          
          nvcc --version
          if %ERRORLEVEL% neq 0 (
              echo "âŒ nvccå‘½ä»¤å¤±è´¥"
              exit /b 1
          )
          
          echo "âœ… CUDAå®‰è£…éªŒè¯æˆåŠŸ"

      - name: Setup Visual Studio environment  
        uses: microsoft/setup-msbuild@v2
        with:
          vs-version: '[17.0,18.0)'  # VS 2022

      - name: Setup Visual Studio Developer Command Prompt
        shell: cmd
        run: |
          echo "è®¾ç½®Visual Studioå¼€å‘ç¯å¢ƒ..."
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat" -arch=x64 -host_arch=x64
          if %ERRORLEVEL% neq 0 (
              echo "å°è¯•ä½¿ç”¨BuildToolsç‰ˆæœ¬..."
              call "C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\Common7\Tools\VsDevCmd.bat" -arch=x64 -host_arch=x64
          )
          
          echo "éªŒè¯ç¼–è¯‘å™¨..."
          cl
          if %ERRORLEVEL% neq 0 (
              echo "âŒ Visual Studioç¼–è¯‘å™¨è®¾ç½®å¤±è´¥"
              exit /b 1
          )
          
          echo "âœ… Visual Studioç¯å¢ƒè®¾ç½®æˆåŠŸ"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ninja setuptools wheel build

      - name: Install PyTorch with correct CUDA version
        shell: powershell
        run: |
          $pythonVersion = "${{ github.event.inputs.python_version || '3.10' }}"
          $torchVersion = "${{ github.event.inputs.torch_version || '2.7' }}"
          $cudaVersion = "${{ needs.validate-compatibility.outputs.cuda_version }}"
          $torchCudaVersion = "${{ needs.validate-compatibility.outputs.torch_short_cuda }}"
          
          Write-Host "å®‰è£…PyTorch $torchVersion (CUDA $cudaVersion)..."
          
          # è®¾ç½®å¯¹åº”çš„torchvisionå’Œtorchaudioç‰ˆæœ¬
          $torchvisionVersion = ""
          $torchaudioVersion = ""
          
          switch ($torchVersion) {
              "2.5" {
                  $torchvisionVersion = "0.20"
                  $torchaudioVersion = "2.5"
              }
              "2.6" {
                  $torchvisionVersion = "0.21" 
                  $torchaudioVersion = "2.6"
              }
              "2.7" {
                  $torchvisionVersion = "0.22"
                  $torchaudioVersion = "2.7"
              }
          }
          
          # æ„å»ºå®‰è£…å‘½ä»¤
          $indexUrl = "https://download.pytorch.org/whl/$torchCudaVersion"
          $installCmd = "pip install --no-cache-dir torch==$torchVersion torchvision==$torchvisionVersion torchaudio==$torchaudioVersion --index-url $indexUrl"
          
          Write-Host "æ‰§è¡Œ: $installCmd"
          
          # æ‰§è¡Œå®‰è£…
          $process = Start-Process -FilePath "pip" -ArgumentList @(
              "install", "--no-cache-dir", 
              "torch==$torchVersion", 
              "torchvision==$torchvisionVersion", 
              "torchaudio==$torchaudioVersion", 
              "--index-url", $indexUrl
          ) -Wait -PassThru -NoNewWindow
          
          if ($process.ExitCode -ne 0) {
              Write-Error "PyTorchå®‰è£…å¤±è´¥"
              exit 1
          }
          
          Write-Host "âœ… PyTorchå®‰è£…å®Œæˆ"

      - name: Verify PyTorch CUDA support
        run: |
          python -c "import torch; print(f'PyTorchç‰ˆæœ¬: {torch.__version__}')"
          python -c "import torch; print(f'CUDAå¯ç”¨: {torch.cuda.is_available()}')"
          python -c "import torch; print(f'CUDAç‰ˆæœ¬: {torch.version.cuda}') if torch.cuda.is_available() else print('CUDAä¸å¯ç”¨')"

      - name: Set build environment variables
        shell: cmd
        run: |
          echo "è®¾ç½®æ„å»ºç¯å¢ƒå˜é‡..."
          set NUNCHAKU_INSTALL_MODE=ALL
          set NUNCHAKU_BUILD_WHEELS=1
          set DISTUTILS_USE_SDK=1
          set MAX_JOBS=2
          set CL=/MP
          
          echo NUNCHAKU_INSTALL_MODE=ALL>> %GITHUB_ENV%
          echo NUNCHAKU_BUILD_WHEELS=1>> %GITHUB_ENV%
          echo DISTUTILS_USE_SDK=1>> %GITHUB_ENV%
          echo MAX_JOBS=2>> %GITHUB_ENV%
          echo CL=/MP>> %GITHUB_ENV%

      - name: Clean build directory
        shell: cmd
        run: |
          if exist build rd /s /q build
          if exist dist rd /s /q dist
          echo "âœ… æ„å»ºç›®å½•å·²æ¸…ç†"

      - name: Build wheel
        shell: cmd
        run: |
          echo "å¼€å§‹æ„å»ºwheel..."
          
          REM é‡æ–°è®¾ç½®Visual Studioç¯å¢ƒ
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat" -arch=x64 -host_arch=x64 || (
              call "C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\Common7\Tools\VsDevCmd.bat" -arch=x64 -host_arch=x64
          )
          
          REM éªŒè¯ç¯å¢ƒ
          echo "éªŒè¯æ„å»ºç¯å¢ƒ..."
          echo "Python: %PYTHON%"
          echo "CUDA_PATH: %CUDA_PATH%"
          echo "PATH: %PATH%"
          
          where cl
          where nvcc
          
          REM æ„å»º
          python -m build --wheel --no-isolation
          
          if %ERRORLEVEL% neq 0 (
              echo "âŒ æ„å»ºå¤±è´¥"
              exit /b 1
          )
          
          echo "âœ… æ„å»ºå®Œæˆ"

      - name: List built wheels
        shell: powershell
        run: |
          if (Test-Path "dist") {
              Write-Host "æ„å»ºçš„wheelæ–‡ä»¶:"
              Get-ChildItem dist/*.whl | ForEach-Object {
                  Write-Host "  - $($_.Name) ($([math]::Round($_.Length/1MB, 2)) MB)"
              }
          } else {
              Write-Host "âŒ æ²¡æœ‰æ‰¾åˆ°æ„å»ºçš„wheelæ–‡ä»¶"
              exit 1
          }

      - name: Test wheel installation
        shell: powershell
        run: |
          Write-Host "æµ‹è¯•wheelå®‰è£…..."
          
          # åˆ›å»ºæ–°çš„è™šæ‹Ÿç¯å¢ƒè¿›è¡Œæµ‹è¯•
          python -m venv test_env
          & "test_env\Scripts\Activate.ps1"
          
          # å®‰è£…æ„å»ºçš„wheel
          $wheelFile = Get-ChildItem dist/*.whl | Select-Object -First 1
          pip install $wheelFile.FullName
          
          # ç®€å•æµ‹è¯•
          python -c "import nunchaku; print('âœ… nunchakuå¯¼å…¥æˆåŠŸ')"

      - name: Upload wheels as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-wheels-py${{ github.event.inputs.python_version }}-torch${{ github.event.inputs.torch_version }}-cuda${{ needs.validate-compatibility.outputs.cuda_version }}
          path: dist/*.whl
          retention-days: 30

      - name: Build summary
        shell: powershell
        run: |
          Write-Host "ğŸ‰ æ„å»ºæˆåŠŸå®Œæˆ!"
          Write-Host "ğŸ“‹ æ„å»ºä¿¡æ¯:"
          Write-Host "  - Pythonç‰ˆæœ¬: ${{ github.event.inputs.python_version }}"
          Write-Host "  - PyTorchç‰ˆæœ¬: ${{ github.event.inputs.torch_version }}"
          Write-Host "  - CUDAç‰ˆæœ¬: ${{ needs.validate-compatibility.outputs.cuda_version }}"
          Write-Host "  - æ„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          
          if (Test-Path "dist") {
              $wheels = Get-ChildItem dist/*.whl
              Write-Host "  - æ„å»ºæ–‡ä»¶æ•°: $($wheels.Count)"
              Write-Host "  - æ€»å¤§å°: $([math]::Round(($wheels | Measure-Object Length -Sum).Sum/1MB, 2)) MB"
          }
